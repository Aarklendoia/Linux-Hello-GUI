name: Build Debian Package

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # Semantic versioning: 1.0.0, 1.2.3, etc.
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            debhelper \
            dh-python \
            python3-setuptools \
            gettext \
            devscripts
      
      - name: Build Debian package
        run: |
          cd $GITHUB_WORKSPACE
          dpkg-buildpackage -d -us -uc
      
      - name: Verify package contents
        run: |
          PACKAGE=$(ls ../linux-hello-gui_*.deb | head -1)
          echo "Package: $PACKAGE"
          echo "Size: $(ls -lh $PACKAGE | awk '{print $5}')"
          echo "Contents summary:"
          dpkg -c $PACKAGE | grep -E "(\.mo$|desktop|bin/linux-hello-gui)" | wc -l
          echo "Translation files:"
          dpkg -c $PACKAGE | grep "\.mo$" | wc -l
      
      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ../linux-hello-gui_*.deb
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
